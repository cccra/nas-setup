---
- name: Make sure that Nvidia drivers are installed
  become: yes
  package:
    name:
      - "nvidia-driver-{{ ansible_kernel }}"
    state: latest

- name: check if nvidia-docker is installed
  command:
    cmd: which nvidia-docker
  register: nvidia-docker
  changed_when: False
  failed_when: False

- name: Add Nvidia repository
  shell:
    cmd: "curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - distribution=$(. /etc/os-release;echo $ID$VERSION_ID) curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list"
  when: nvidia-docker.rc == 1

- name: install nvidia-docker
  become: yes
  package:
    name:
      - nvidia-docker2
    state: latest

- name: Make sure the {{ container_name }} container is created and running
  docker_container:
    name: "{{ container_name }}"
    image: "ghcr.io/linuxserver/jellyfin"
    networks:
      - name: swag_public_macvlan
        ipv4_address: "{{ ip_address }}"
    pull: yes
    privileged: yes
    device_requests:
      - driver: nvidia
        count: -1
        capabilities:
          - gpu
    state: 'started'
    env:
      "PUID": "{{ guid }}"
      "PGID": "{{ guid }}"
      "TZ": "{{ timezone }}"
      "VERSION": "latest"
    volumes:
      - "{{ docker_dir }}/{{ container_name }}:/config"
      - "{{ mergerfs_root }}/Media/TV:/data/TV"
      - "{{ mergerfs_root }}_slow/Media/Transcodes:/config/data/transcodes"
      - "{{ mergerfs_root }}/Media/Metadata:/metadata"
      - "{{ mergerfs_root }}/Media/Cache:/data/Cache"
      - "{{ mergerfs_root }}/Media/Movies:/data/Movies"
      - "/etc/localtime:/etc/localtime:ro"
    restart_policy: unless-stopped
